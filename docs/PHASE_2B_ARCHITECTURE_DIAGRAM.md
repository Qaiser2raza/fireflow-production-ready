# Phase 2b Architecture Diagram

## Request Flow with JWT Authentication

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         CLIENT (React/Electron)                             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                              â”‚
â”‚  User enters PIN â†’ LoginView â†’ POST /api/auth/login                         â”‚
â”‚                                    â†“                                        â”‚
â”‚                              Response:                                      â”‚
â”‚                              {                                              â”‚
â”‚                                staff: {...},                                â”‚
â”‚                                tokens: {                                    â”‚
â”‚                                  access_token: "eyJhbGc...",               â”‚
â”‚                                  refresh_token: "eyJhbGc...",              â”‚
â”‚                                  expires_in: 900                            â”‚
â”‚                                }                                            â”‚
â”‚                              }                                              â”‚
â”‚                                â†“                                            â”‚
â”‚                        Store in sessionStorage:                             â”‚
â”‚                        - accessToken                                        â”‚
â”‚                        - refreshToken                                       â”‚
â”‚                        - accessTokenExpiry                                  â”‚
â”‚                                â†“                                            â”‚
â”‚  All API calls use apiClient:                                              â”‚
â”‚                                â†“                                            â”‚
â”‚  const data = await apiCall('/api/orders')                                 â”‚
â”‚                                â†“                                            â”‚
â”‚  Headers: {                                                                 â”‚
â”‚    'Authorization': 'Bearer eyJhbGc...'                                    â”‚
â”‚  }                                                                          â”‚
â”‚                                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                    â†“
                            (HTTP Request)
                                    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         SERVER (Express.js)                                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                              â”‚
â”‚  Request arrives at Express                                                 â”‚
â”‚         â†“                                                                   â”‚
â”‚  1. CORS Middleware (allowed)                                              â”‚
â”‚  2. express.json() (parse body)                                            â”‚
â”‚  3. Logging Middleware (log request)                                       â”‚
â”‚         â†“                                                                   â”‚
â”‚  4. GLOBAL JWT MIDDLEWARE:                                                 â”‚
â”‚     if (path === '/api/health' || '/api/auth/login' || '/api/auth/refresh')
â”‚         â†’ skip JWT check, pass to next handler                             â”‚
â”‚     else                                                                    â”‚
â”‚         â†’ call authMiddleware(req, res, next)                              â”‚
â”‚         â†“                                                                   â”‚
â”‚     authMiddleware does:                                                   â”‚
â”‚     a) Extract token from "Authorization: Bearer <token>"                  â”‚
â”‚     b) Call jwtService.verifyToken(token)                                 â”‚
â”‚        - Parse token (3 parts separated by .)                              â”‚
â”‚        - Verify signature (HMAC-SHA256)                                    â”‚
â”‚        - Check expiry (exp < now?)                                         â”‚
â”‚        - Validate claims (has staffId, restaurantId, role)               â”‚
â”‚     c) If invalid â†’ return 401 Unauthorized                               â”‚
â”‚     d) If expired â†’ return 410 Gone                                        â”‚
â”‚     e) If valid â†’ attach to req:                                          â”‚
â”‚        - req.staffId                                                       â”‚
â”‚        - req.restaurantId                                                  â”‚
â”‚        - req.role                                                          â”‚
â”‚        - req.staff (full object)                                          â”‚
â”‚     f) Call next()                                                         â”‚
â”‚         â†“                                                                   â”‚
â”‚  5. Route Handler receives request:                                        â”‚
â”‚                                                                              â”‚
â”‚     Example: GET /api/orders                                               â”‚
â”‚     (async (req, res) => {                                                 â”‚
â”‚       const staffId = req.staffId;          âœ… From JWT                   â”‚
â”‚       const restaurantId = req.restaurantId; âœ… From JWT                  â”‚
â”‚                                                                              â”‚
â”‚       const orders = await db.find({                                       â”‚
â”‚         restaurant_id: restaurantId                                        â”‚
â”‚       });                                                                   â”‚
â”‚                                                                              â”‚
â”‚       res.json(orders);                                                    â”‚
â”‚     })                                                                      â”‚
â”‚                                                                              â”‚
â”‚  6. Response sent back to client                                           â”‚
â”‚                                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                    â†“
                            (HTTP Response)
                                    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    CLIENT RECEIVES RESPONSE                                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                              â”‚
â”‚  if (response.status === 200)                                              â”‚
â”‚    â†’ Parse JSON, update UI                                                 â”‚
â”‚                                                                              â”‚
â”‚  if (response.status === 401)                                              â”‚
â”‚    â†’ Invalid/missing token                                                 â”‚
â”‚    â†’ Redirect to login                                                     â”‚
â”‚                                                                              â”‚
â”‚  if (response.status === 410)                                              â”‚
â”‚    â†’ Token expired                                                         â”‚
â”‚    â†’ Automatic refresh:                                                    â”‚
â”‚       POST /api/auth/refresh with refreshToken                            â”‚
â”‚       â†’ Get new accessToken                                                â”‚
â”‚       â†’ Retry original request                                             â”‚
â”‚                                                                              â”‚
â”‚  if (response.status === 403)                                              â”‚
â”‚    â†’ Insufficient permissions                                              â”‚
â”‚    â†’ Show error message                                                    â”‚
â”‚                                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## JWT Token Structure

```
Token Format: Header.Payload.Signature

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Header                                                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ {                                                         â”‚
â”‚   "alg": "HS256",    // Algorithm                         â”‚
â”‚   "typ": "JWT"       // Type                              â”‚
â”‚ }                                                         â”‚
â”‚                                                           â”‚
â”‚ Encoded: eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Payload (Claims)                                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ {                                                         â”‚
â”‚   "staffId": "12345",           // Staff ID               â”‚
â”‚   "restaurantId": "67890",      // Restaurant ID          â”‚
â”‚   "role": "manager",            // Staff role             â”‚
â”‚   "name": "John Doe",           // Display name           â”‚
â”‚   "type": "access",             // Token type             â”‚
â”‚   "iat": 1705756800,            // Issued At              â”‚
â”‚   "exp": 1705757700,            // Expiration (15 min)    â”‚
â”‚   "jti": "unique-id-123"        // JWT ID                 â”‚
â”‚ }                                                         â”‚
â”‚                                                           â”‚
â”‚ Encoded: eyJzdGFmZklkIjoiMTIzNDUiLCJyb2xlIjoibWFu...   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Signature                                                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ HMAC-SHA256 (                                             â”‚
â”‚   base64url(header) + "." + base64url(payload),           â”‚
â”‚   secret                                                  â”‚
â”‚ )                                                         â”‚
â”‚                                                           â”‚
â”‚ Result: SflKxwRJSMeKKF2QT4fwpMeJf36POk6yJV_adQ... (256  â”‚
â”‚                                                           â”‚
â”‚ If token is tampered:                                     â”‚
â”‚   - Signature invalid                                     â”‚
â”‚   - Verification fails                                    â”‚
â”‚   - Rejected (401 Unauthorized)                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Complete JWT: 
eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdGFmZklkIjoiMTI...
SflKxwRJSMeKKF2QT4fwpMeJf36POk6yJV_adQ
```

---

## Authentication Middleware Flow

```
Client Request Arrives
â”‚
â”œâ”€ Authorization Header Present?
â”‚  â”‚
â”‚  â”œâ”€ NO  â†’ Return 401 Unauthorized
â”‚  â”‚
â”‚  â””â”€ YES â†’ Extract token from "Bearer <token>"
â”‚           â”‚
â”‚           â”œâ”€ Token has 3 parts (header.payload.signature)?
â”‚           â”‚  â”‚
â”‚           â”‚  â”œâ”€ NO  â†’ Return 401 Invalid Token Format
â”‚           â”‚  â”‚
â”‚           â”‚  â””â”€ YES â†’ Continue
â”‚           â”‚           â”‚
â”‚           â”‚           â”œâ”€ Verify Signature
â”‚           â”‚           â”‚  (HMAC-SHA256 with secret)
â”‚           â”‚           â”‚  â”‚
â”‚           â”‚           â”‚  â”œâ”€ INVALID  â†’ Return 401 Invalid Signature
â”‚           â”‚           â”‚  â”‚
â”‚           â”‚           â”‚  â””â”€ VALID â†’ Continue
â”‚           â”‚           â”‚           â”‚
â”‚           â”‚           â”‚           â”œâ”€ Check Expiry
â”‚           â”‚           â”‚           â”‚  (exp > now?)
â”‚           â”‚           â”‚           â”‚  â”‚
â”‚           â”‚           â”‚           â”‚  â”œâ”€ EXPIRED â†’ Return 410 Token Expired
â”‚           â”‚           â”‚           â”‚  â”‚
â”‚           â”‚           â”‚           â”‚  â””â”€ VALID â†’ Continue
â”‚           â”‚           â”‚           â”‚           â”‚
â”‚           â”‚           â”‚           â”‚           â”œâ”€ Validate Claims
â”‚           â”‚           â”‚           â”‚           â”‚  - Has staffId?
â”‚           â”‚           â”‚           â”‚           â”‚  - Has restaurantId?
â”‚           â”‚           â”‚           â”‚           â”‚  - Has role?
â”‚           â”‚           â”‚           â”‚           â”‚  â”‚
â”‚           â”‚           â”‚           â”‚           â”‚  â”œâ”€ MISSING â†’ 401 Invalid Claims
â”‚           â”‚           â”‚           â”‚           â”‚  â”‚
â”‚           â”‚           â”‚           â”‚           â”‚  â””â”€ PRESENT â†’ Continue
â”‚           â”‚           â”‚           â”‚           â”‚              â”‚
â”‚           â”‚           â”‚           â”‚           â”‚              â”œâ”€ Check Token Type
â”‚           â”‚           â”‚           â”‚           â”‚              â”‚  (type === 'access'?)
â”‚           â”‚           â”‚           â”‚           â”‚              â”‚  â”‚
â”‚           â”‚           â”‚           â”‚           â”‚              â”‚  â”œâ”€ NO (is 'refresh') 
â”‚           â”‚           â”‚           â”‚           â”‚              â”‚  â”‚  â†’ 401 Wrong Token Type
â”‚           â”‚           â”‚           â”‚           â”‚              â”‚  â”‚
â”‚           â”‚           â”‚           â”‚           â”‚              â”‚  â””â”€ YES â†’ Continue
â”‚           â”‚           â”‚           â”‚           â”‚              â”‚         â”‚
â”‚           â”‚           â”‚           â”‚           â”‚              â”‚         â”œâ”€ Attach to req:
â”‚           â”‚           â”‚           â”‚           â”‚              â”‚         â”‚  - req.staffId
â”‚           â”‚           â”‚           â”‚           â”‚              â”‚         â”‚  - req.restaurantId
â”‚           â”‚           â”‚           â”‚           â”‚              â”‚         â”‚  - req.role
â”‚           â”‚           â”‚           â”‚           â”‚              â”‚         â”‚
â”‚           â”‚           â”‚           â”‚           â”‚              â”‚         â””â”€ Call next()
â”‚           â”‚           â”‚           â”‚           â”‚              â”‚             â”‚
â”‚           â”‚           â”‚           â”‚           â”‚              â”‚             â””â”€ Route Handler
â”‚           â”‚           â”‚           â”‚           â”‚              â”‚                (receives request)
â”‚           â”‚           â”‚           â”‚           â”‚              â”‚
â”‚           â”‚           â”‚           â”‚           â”‚              â””â”€ Return 403 Forbidden
â”‚           â”‚           â”‚           â”‚           â”‚
â”‚           â”‚           â”‚           â”‚           â””â”€ Return 403 Forbidden
â”‚           â”‚           â”‚           â”‚
â”‚           â”‚           â”‚           â””â”€ Return 401 Invalid Claims
â”‚           â”‚           â”‚
â”‚           â”‚           â””â”€ Return 401 Invalid Signature
â”‚           â”‚
â”‚           â””â”€ Return 401 Invalid Format
â”‚
â””â”€ Return 401 No Authorization Header
```

---

## Access Control Decision Tree

```
                    Request to /api/endpoint
                            â”‚
                            â”œâ”€ Is endpoint public?
                            â”‚  (/api/health, /api/auth/login, /api/auth/refresh)
                            â”‚  â”‚
                            â”‚  â”œâ”€ YES â†’ Allow (skip JWT check)
                            â”‚  â”‚
                            â”‚  â””â”€ NO â†’ Require JWT authentication
                            â”‚         (validate token)
                            â”‚         â”‚
                            â”‚         â””â”€ Token valid? (401/410 if not)
                            â”‚            â”‚
                            â”‚            â”œâ”€ YES â†’ Check access level
                            â”‚            â”‚        â”‚
                            â”‚            â”‚        â”œâ”€ No role requirement
                            â”‚            â”‚        â”‚  â†’ Allow
                            â”‚            â”‚        â”‚
                            â”‚            â”‚        â”œâ”€ Role required (e.g., 'manager')
                            â”‚            â”‚        â”‚  â”‚
                            â”‚            â”‚        â”‚  â”œâ”€ User has role?
                            â”‚            â”‚        â”‚  â”‚  â”‚
                            â”‚            â”‚        â”‚  â”‚  â”œâ”€ YES â†’ Allow
                            â”‚            â”‚        â”‚  â”‚  â”‚
                            â”‚            â”‚        â”‚  â”‚  â””â”€ NO â†’ Deny (403 Forbidden)
                            â”‚            â”‚        â”‚  â”‚
                            â”‚            â”‚        â”‚  â””â”€ Check restaurant
                            â”‚            â”‚        â”‚     â”‚
                            â”‚            â”‚        â”‚     â”œâ”€ User in restaurant?
                            â”‚            â”‚        â”‚     â”‚  â”‚
                            â”‚            â”‚        â”‚     â”‚  â”œâ”€ YES â†’ Allow
                            â”‚            â”‚        â”‚     â”‚  â”‚
                            â”‚            â”‚        â”‚     â”‚  â””â”€ NO â†’ Deny (403 Forbidden)
                            â”‚            â”‚        â”‚
                            â”‚            â”‚        â””â”€ End: Proceed to route handler
                            â”‚            â”‚
                            â”‚            â””â”€ NO â†’ Deny (401/410)
```

---

## File Dependencies

```
src/api/server.ts
â”œâ”€ imports: jwtService (from JwtService.ts)
â”œâ”€ imports: authMiddleware, requireRole, belongsToRestaurant
â”‚           (from authMiddleware.ts)
â”‚
â””â”€ Uses:
   â”œâ”€ app.use() for JWT middleware
   â”œâ”€ jwtService.generateAccessToken()
   â”œâ”€ jwtService.generateRefreshToken()
   â”œâ”€ jwtService.verifyToken()
   â””â”€ route handlers: authMiddleware, requireRole

src/api/middleware/authMiddleware.ts
â”œâ”€ imports: JwtService (from JwtService.ts)
â”œâ”€ imports: PrismaClient (for staff lookup)
â”‚
â””â”€ Exports:
   â”œâ”€ authMiddleware (Express middleware)
   â”œâ”€ requireRole (Role checker)
   â””â”€ belongsToRestaurant (Tenant checker)

src/api/services/auth/JwtService.ts
â”œâ”€ imports: crypto (Node.js)
â”‚
â””â”€ Exports:
   â”œâ”€ generateAccessToken()
   â”œâ”€ generateRefreshToken()
   â”œâ”€ verifyToken()
   â”œâ”€ extractTokenFromHeader()
   â””â”€ jwtService (singleton instance)

src/shared/lib/apiClient.ts (CLIENT)
â”œâ”€ imports: fetch (browser API)
â”‚
â””â”€ Exports:
   â”œâ”€ apiCall() (main utility)
   â”œâ”€ refreshAccessToken()
   â”œâ”€ logout()
   â”œâ”€ getAccessToken()
   â””â”€ isAuthenticated()

src/auth/views/LoginView.tsx (CLIENT)
â”œâ”€ imports: apiClient
â”‚
â””â”€ Uses:
   â”œâ”€ fetch('/api/auth/login')
   â”œâ”€ Store tokens from response
   â””â”€ Redirect on success
```

---

## Token Lifecycle

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1. TOKEN CREATION (on login)                                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                              â”‚
â”‚ User enters PIN â†’ Server generates tokens:                  â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚ â”‚ Access Token                 Refresh Token           â”‚   â”‚
â”‚ â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤   â”‚
â”‚ â”‚ Lifetime: 15 minutes         Lifetime: 7 days       â”‚   â”‚
â”‚ â”‚ Use: API requests            Use: Get new access    â”‚   â”‚
â”‚ â”‚ Type: 'access'               Type: 'refresh'        â”‚   â”‚
â”‚ â”‚ Expires: now + 900 sec       Expires: now + 604800 sâ”‚   â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 2. TOKEN STORAGE (client-side)                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                              â”‚
â”‚ sessionStorage:                                             â”‚
â”‚ â”œâ”€ accessToken                                             â”‚
â”‚ â”œâ”€ refreshToken                                            â”‚
â”‚ â””â”€ accessTokenExpiry                                       â”‚
â”‚                                                              â”‚
â”‚ Cleared when: Browser tab closes                            â”‚
â”‚ Cleared when: Logout called                                â”‚
â”‚ Cleared when: Redirect to login                             â”‚
â”‚                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 3. TOKEN USAGE (API requests)                               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                              â”‚
â”‚ â”Œâ”€ 0 minutes:                                              â”‚
â”‚ â”‚ User logs in                                             â”‚
â”‚ â”‚ Client gets: access_token + refresh_token               â”‚
â”‚ â”‚ â†’ Store both                                             â”‚
â”‚ â”‚                                                          â”‚
â”‚ â”œâ”€ 0-15 minutes:                                           â”‚
â”‚ â”‚ API calls with access_token                             â”‚
â”‚ â”‚ â†’ Header: Authorization: Bearer <access_token>          â”‚
â”‚ â”‚ â†’ All requests succeed (200)                            â”‚
â”‚ â”‚                                                          â”‚
â”‚ â”œâ”€ ~7.5 minutes:                                           â”‚
â”‚ â”‚ apiClient notices token expiring soon                    â”‚
â”‚ â”‚ â†’ Proactively refresh access_token                       â”‚
â”‚ â”‚ â†’ POST /api/auth/refresh with refresh_token             â”‚
â”‚ â”‚ â†’ Get new access_token                                   â”‚
â”‚ â”‚ â†’ Continue with new token                                â”‚
â”‚ â”‚                                                          â”‚
â”‚ â”œâ”€ 15 minutes:                                             â”‚
â”‚ â”‚ If no refresh happened earlier:                          â”‚
â”‚ â”‚ API call with expired access_token                       â”‚
â”‚ â”‚ â†’ Server returns 410 Gone                                â”‚
â”‚ â”‚ â†’ Client calls POST /api/auth/refresh                    â”‚
â”‚ â”‚ â†’ Get new access_token                                   â”‚
â”‚ â”‚ â†’ Retry API call                                         â”‚
â”‚ â”‚                                                          â”‚
â”‚ â””â”€ 7 days:                                                 â”‚
â”‚   Refresh token expires                                    â”‚
â”‚   â†’ POST /api/auth/refresh fails (401)                     â”‚
â”‚   â†’ User redirected to login                               â”‚
â”‚   â†’ Must enter PIN again                                   â”‚
â”‚                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 4. TOKEN REFRESH (when access expires)                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                              â”‚
â”‚ POST /api/auth/refresh                                      â”‚
â”‚ Body: { refresh_token: "eyJhbGc..." }                       â”‚
â”‚                                                              â”‚
â”‚ Response (200):                                             â”‚
â”‚ {                                                           â”‚
â”‚   access_token: "eyJhbGc...",  // New access token          â”‚
â”‚   expires_in: 900               // 15 minutes               â”‚
â”‚ }                                                           â”‚
â”‚                                                              â”‚
â”‚ Update storage:                                             â”‚
â”‚ sessionStorage.accessToken = new token                     â”‚
â”‚ sessionStorage.accessTokenExpiry = now + 900 sec            â”‚
â”‚                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 5. TOKEN REVOCATION (on logout)                             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                              â”‚
â”‚ POST /api/auth/logout                                       â”‚
â”‚ Header: Authorization: Bearer <access_token>               â”‚
â”‚                                                              â”‚
â”‚ Server does:                                                â”‚
â”‚ â”œâ”€ Log audit event (STAFF_LOGOUT)                           â”‚
â”‚ â””â”€ (Phase 2c: Add token to blacklist)                       â”‚
â”‚                                                              â”‚
â”‚ Client does:                                                â”‚
â”‚ â”œâ”€ Clear sessionStorage (all tokens)                        â”‚
â”‚ â””â”€ Redirect to /login                                       â”‚
â”‚                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Error Responses

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 401 UNAUTHORIZED                                             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                              â”‚
â”‚ Causes:                                                     â”‚
â”‚ â”œâ”€ Missing Authorization header                            â”‚
â”‚ â”œâ”€ Invalid token format                                    â”‚
â”‚ â”œâ”€ Invalid signature (tampered token)                      â”‚
â”‚ â”œâ”€ Missing required claims                                 â”‚
â”‚ â”œâ”€ Wrong token type (refresh instead of access)           â”‚
â”‚ â””â”€ Staff no longer active in database                      â”‚
â”‚                                                              â”‚
â”‚ Client action:                                              â”‚
â”‚ â””â”€ Redirect to /login                                       â”‚
â”‚                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 410 GONE (Token Expired)                                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                              â”‚
â”‚ Causes:                                                     â”‚
â”‚ â””â”€ exp < current_timestamp (token expired)                 â”‚
â”‚                                                              â”‚
â”‚ Client action:                                              â”‚
â”‚ â”œâ”€ Call POST /api/auth/refresh with refresh_token         â”‚
â”‚ â”œâ”€ Get new access_token                                     â”‚
â”‚ â””â”€ Retry original request                                   â”‚
â”‚                                                              â”‚
â”‚ If refresh fails (refresh token also expired):             â”‚
â”‚ â””â”€ Redirect to /login                                       â”‚
â”‚                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 403 FORBIDDEN                                                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                              â”‚
â”‚ Causes:                                                     â”‚
â”‚ â”œâ”€ Insufficient role (e.g., waiter trying to call manager   â”‚
â”‚ â”‚  endpoint)                                               â”‚
â”‚ â”œâ”€ Wrong restaurant (staff from restaurant A accessing     â”‚
â”‚ â”‚  data from restaurant B)                                 â”‚
â”‚ â””â”€ Other permission denied                                 â”‚
â”‚                                                              â”‚
â”‚ Client action:                                              â”‚
â”‚ â””â”€ Show error message to user                              â”‚
â”‚                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 400 BAD REQUEST                                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                              â”‚
â”‚ Causes:                                                     â”‚
â”‚ â”œâ”€ Missing refresh_token in request body                    â”‚
â”‚ â”œâ”€ Invalid PIN on login                                    â”‚
â”‚ â””â”€ Other validation errors                                 â”‚
â”‚                                                              â”‚
â”‚ Client action:                                              â”‚
â”‚ â””â”€ Show error message, retry or ask user                    â”‚
â”‚                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

**Created by**: Ralf (Senior Full-Stack Engineer)  
**Date**: Jan 20, 2026  
**Status**: ğŸŸ¢ Production Ready
